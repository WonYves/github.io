<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Wiess&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/ohwo2.jpg">
    <meta name="description" content="分享笔记，技术博客">
    
    <link rel="preload" href="/assets/css/0.styles.d6ad21ed.css" as="style"><link rel="preload" href="/assets/js/app.47b00d9e.js" as="script"><link rel="preload" href="/assets/js/2.63c13255.js" as="script"><link rel="preload" href="/assets/js/14.9ccbfb79.js" as="script"><link rel="prefetch" href="/assets/js/10.6f45d255.js"><link rel="prefetch" href="/assets/js/11.f8205a47.js"><link rel="prefetch" href="/assets/js/12.bd1b258c.js"><link rel="prefetch" href="/assets/js/13.d54cd060.js"><link rel="prefetch" href="/assets/js/15.8a848db8.js"><link rel="prefetch" href="/assets/js/16.bbee7035.js"><link rel="prefetch" href="/assets/js/17.a77f7b7a.js"><link rel="prefetch" href="/assets/js/18.2505abdc.js"><link rel="prefetch" href="/assets/js/19.3b9dec56.js"><link rel="prefetch" href="/assets/js/20.fbcc61e3.js"><link rel="prefetch" href="/assets/js/21.76693485.js"><link rel="prefetch" href="/assets/js/22.015311e2.js"><link rel="prefetch" href="/assets/js/23.4965c38b.js"><link rel="prefetch" href="/assets/js/24.7d8fcfee.js"><link rel="prefetch" href="/assets/js/25.1fad7845.js"><link rel="prefetch" href="/assets/js/26.78bfc509.js"><link rel="prefetch" href="/assets/js/27.4ccd57ee.js"><link rel="prefetch" href="/assets/js/28.f9057288.js"><link rel="prefetch" href="/assets/js/29.ebde7145.js"><link rel="prefetch" href="/assets/js/3.a4d9c696.js"><link rel="prefetch" href="/assets/js/30.30876a1e.js"><link rel="prefetch" href="/assets/js/31.6b81c6bf.js"><link rel="prefetch" href="/assets/js/32.37b3d365.js"><link rel="prefetch" href="/assets/js/33.f2cc1a34.js"><link rel="prefetch" href="/assets/js/34.c3864ec8.js"><link rel="prefetch" href="/assets/js/35.d8109eef.js"><link rel="prefetch" href="/assets/js/36.964f8786.js"><link rel="prefetch" href="/assets/js/37.97f0ce0a.js"><link rel="prefetch" href="/assets/js/38.0fab69ca.js"><link rel="prefetch" href="/assets/js/4.94733d25.js"><link rel="prefetch" href="/assets/js/5.2ea06e07.js"><link rel="prefetch" href="/assets/js/6.8d81f0ec.js"><link rel="prefetch" href="/assets/js/7.1e08345a.js"><link rel="prefetch" href="/assets/js/8.0d63082f.js"><link rel="prefetch" href="/assets/js/9.f8d4bff4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d6ad21ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Wiess's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React" class="dropdown-title"><span class="title">React</span> <span class="arrow down"></span></button> <button type="button" aria-label="React" class="mobile-dropdown-title"><span class="title">React</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/React/react.html" class="nav-link">
  React基础语法
</a></li><li class="dropdown-item"><!----> <a href="/React/hook.html" class="nav-link">
  React-Hooks
</a></li><li class="dropdown-item"><!----> <a href="/React/Redux.html" class="nav-link">
  Redux
</a></li><li class="dropdown-item"><!----> <a href="/React/React-Router.html" class="nav-link">
  React-Router
</a></li><li class="dropdown-item"><!----> <a href="/React/深入理解Redux.html" class="nav-link">
  深入理解Redux
</a></li><li class="dropdown-item"><!----> <a href="/React/Immutable.html" class="nav-link">
  Immutable
</a></li><li class="dropdown-item"><!----> <a href="/React/RouterV6.html" class="nav-link">
  RouterV6
</a></li><li class="dropdown-item"><!----> <a href="/talk/react-hooks中的过期闭包问题.html" class="nav-link">
  react-hooks中的过期闭包问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue" class="mobile-dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Vue/Vue双向绑定原理.html" class="nav-link">
  Vue双向绑定
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript" class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow down"></span></button> <button type="button" aria-label="JavaScript" class="mobile-dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/JavaScript/JavaScript.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/浅拷贝和深拷贝.html" class="nav-link">
  浅拷贝和深拷贝
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/事件循环Eventloop.html" class="nav-link">
  事件循环EventLoop
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/重绘回流.html" class="nav-link">
  重绘回流(重排)
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/call、apply、bind方法.html" class="nav-link">
  call、apply、bind方法
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/TypeScript.html" class="nav-link">
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/talk/Ajax、Fetch、Axios这三者有什么区别.html" class="nav-link">
  Ajax、Fetch、Axios这三者有什么区别
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人项目" class="dropdown-title"><span class="title">个人项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="个人项目" class="mobile-dropdown-title"><span class="title">个人项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/个人项目/ReactEvents.html" class="nav-link">
  ReactEvents
</a></li><li class="dropdown-item"><!----> <a href="/个人项目/Vue2-文章后台管理系统.html" class="nav-link">
  Vue2-文章后台管理系统
</a></li><li class="dropdown-item"><!----> <a href="/个人项目/Vue2-MovieShop.html" class="nav-link">
  Vue2-MovieShop
</a></li><li class="dropdown-item"><!----> <a href="/个人项目/Yi-MiniShop.html" class="nav-link">
  Yi-MiniShop
</a></li><li class="dropdown-item"><!----> <a href="/个人项目/Netease-Cloud-Music.html" class="nav-link">
  Netease-Cloud-Music(完成中)
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随便聊聊" class="dropdown-title"><span class="title">随便聊聊</span> <span class="arrow down"></span></button> <button type="button" aria-label="随便聊聊" class="mobile-dropdown-title"><span class="title">随便聊聊</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Css/CSS.html" class="nav-link">
  Css基础+css3
</a></li><li class="dropdown-item"><!----> <a href="/Css/css属性.html" class="nav-link">
  Css常用属性
</a></li><li class="dropdown-item"><!----> <a href="/WebPack/WebPack.html" class="nav-link">
  WebPack入门基础
</a></li><li class="dropdown-item"><!----> <a href="/WebPack/WebPack面试题.html" class="nav-link">
  WebPack面试题
</a></li><li class="dropdown-item"><!----> <a href="/talk/talk.html" class="nav-link">
  高频面试题
</a></li><li class="dropdown-item"><!----> <a href="/talk/git.html" class="nav-link">
  git使用
</a></li><li class="dropdown-item"><!----> <a href="/talk/小程序.html" class="nav-link">
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/talk/uniapp购物车.html" class="nav-link">
  uniapp购物车
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React" class="dropdown-title"><span class="title">React</span> <span class="arrow down"></span></button> <button type="button" aria-label="React" class="mobile-dropdown-title"><span class="title">React</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/React/react.html" class="nav-link">
  React基础语法
</a></li><li class="dropdown-item"><!----> <a href="/React/hook.html" class="nav-link">
  React-Hooks
</a></li><li class="dropdown-item"><!----> <a href="/React/Redux.html" class="nav-link">
  Redux
</a></li><li class="dropdown-item"><!----> <a href="/React/React-Router.html" class="nav-link">
  React-Router
</a></li><li class="dropdown-item"><!----> <a href="/React/深入理解Redux.html" class="nav-link">
  深入理解Redux
</a></li><li class="dropdown-item"><!----> <a href="/React/Immutable.html" class="nav-link">
  Immutable
</a></li><li class="dropdown-item"><!----> <a href="/React/RouterV6.html" class="nav-link">
  RouterV6
</a></li><li class="dropdown-item"><!----> <a href="/talk/react-hooks中的过期闭包问题.html" class="nav-link">
  react-hooks中的过期闭包问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue" class="mobile-dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Vue/Vue双向绑定原理.html" class="nav-link">
  Vue双向绑定
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript" class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow down"></span></button> <button type="button" aria-label="JavaScript" class="mobile-dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/JavaScript/JavaScript.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/浅拷贝和深拷贝.html" class="nav-link">
  浅拷贝和深拷贝
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/事件循环Eventloop.html" class="nav-link">
  事件循环EventLoop
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/重绘回流.html" class="nav-link">
  重绘回流(重排)
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/call、apply、bind方法.html" class="nav-link">
  call、apply、bind方法
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/TypeScript.html" class="nav-link">
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/talk/Ajax、Fetch、Axios这三者有什么区别.html" class="nav-link">
  Ajax、Fetch、Axios这三者有什么区别
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人项目" class="dropdown-title"><span class="title">个人项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="个人项目" class="mobile-dropdown-title"><span class="title">个人项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/个人项目/ReactEvents.html" class="nav-link">
  ReactEvents
</a></li><li class="dropdown-item"><!----> <a href="/个人项目/Vue2-文章后台管理系统.html" class="nav-link">
  Vue2-文章后台管理系统
</a></li><li class="dropdown-item"><!----> <a href="/个人项目/Vue2-MovieShop.html" class="nav-link">
  Vue2-MovieShop
</a></li><li class="dropdown-item"><!----> <a href="/个人项目/Yi-MiniShop.html" class="nav-link">
  Yi-MiniShop
</a></li><li class="dropdown-item"><!----> <a href="/个人项目/Netease-Cloud-Music.html" class="nav-link">
  Netease-Cloud-Music(完成中)
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随便聊聊" class="dropdown-title"><span class="title">随便聊聊</span> <span class="arrow down"></span></button> <button type="button" aria-label="随便聊聊" class="mobile-dropdown-title"><span class="title">随便聊聊</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Css/CSS.html" class="nav-link">
  Css基础+css3
</a></li><li class="dropdown-item"><!----> <a href="/Css/css属性.html" class="nav-link">
  Css常用属性
</a></li><li class="dropdown-item"><!----> <a href="/WebPack/WebPack.html" class="nav-link">
  WebPack入门基础
</a></li><li class="dropdown-item"><!----> <a href="/WebPack/WebPack面试题.html" class="nav-link">
  WebPack面试题
</a></li><li class="dropdown-item"><!----> <a href="/talk/talk.html" class="nav-link">
  高频面试题
</a></li><li class="dropdown-item"><!----> <a href="/talk/git.html" class="nav-link">
  git使用
</a></li><li class="dropdown-item"><!----> <a href="/talk/小程序.html" class="nav-link">
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/talk/uniapp购物车.html" class="nav-link">
  uniapp购物车
</a></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a name="ukyAJ"></a></p> <h1 id="一、什么是事件循环"><a href="#一、什么是事件循环" class="header-anchor">#</a> 一、什么是事件循环？</h1> <p>众所周知，JS是单线程语言，同步执行代码，如果遇到执行时间比较长的函数，就会阻塞代码的执行，因此有了<strong>异步</strong>来解决这个问题。<br>而<strong>事件循环就是一个异步机制，也是执行消息队列的机制。</strong></p> <ol><li>JS主线程执行过程遇到异步任务，就会交给相应的浏览器异步线程去处理</li> <li>直到异步任务执行出结果，就往任务队列里面添加一个事件（回调函数）</li> <li>当执行栈中同步任务执行完毕（此时JS引擎空闲），就去查询任务队列，取出一个异步任务到主线程中执行</li> <li>重复该动作就是事件循环机制
<a name="vw3IT"></a></li></ol> <h1 id="二、任务队列"><a href="#二、任务队列" class="header-anchor">#</a> 二、任务队列</h1> <p><strong>如上图，任务队列存在多个，同一任务队列内，按队列顺序被主线程取走；</strong><br><strong>不同任务队列之间，存在着优先级，优先级高的优先获取（如用户I/O）；</strong> <a name="QVIAC"></a></p> <h2 id="_1、任务队列的类型"><a href="#_1、任务队列的类型" class="header-anchor">#</a> 1、任务队列的类型</h2> <p>任务队列存在两种类型，一种为<strong>microtask queue（微任务）</strong>，另一种为<strong>macrotask queue（宏任务）</strong>。图中所列出的任务队列均为macrotask queue，而ES6 的 promise［ECMAScript标准］产生的任务队列为microtask queue。
<a name="wqYRU"></a></p> <h2 id="_2、宏任务"><a href="#_2、宏任务" class="header-anchor">#</a> 2、宏任务</h2> <p>浏览器为了能够使得JS内部(macro)task与DOM任务能够有序的执行，<strong>会在一个(macro)task执行结束后，在下一个(macro)task 执行开始前，对页面进行重新渲染</strong>，流程如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">(</span>macro<span class="token punctuation">)</span>task<span class="token operator">-</span><span class="token operator">&gt;</span>渲染<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>macro<span class="token punctuation">)</span>task<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token operator">...</span>
</code></pre></div><p>(macro)task主要包含：script(整体代码)、setTimeout、setInterval、I/O、UI交互事件、postMessage、MessageChannel、setImmediate(Node.js 环境)
<a name="wzrpL"></a></p> <h2 id="_3、微任务"><a href="#_3、微任务" class="header-anchor">#</a> 3、微任务</h2> <p>microtask（又称为微任务），<strong>可以理解是在当前 task 执行结束后立即执行的任务</strong>。也就是说，在当前task任务后，下一个task之前，在渲染之前。<br>所以它的响应速度相比setTimeout（setTimeout是task）会更快，因为无需等渲染。也就是说，在某一个macrotask执行完后，就会将在它执行期间产生的所有microtask都执行完毕（在渲染前）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">(</span>macro<span class="token punctuation">)</span>task<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">清空微任务</span><span class="token punctuation">(</span>microtask<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>渲染<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>macro<span class="token punctuation">)</span>task<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token operator">...</span>
</code></pre></div><p>microtask主要包含：Promise.then、MutaionObserver、process.nextTick(Node.js 环境) 、await后面的语句(相当于Promise.then里面的语句)
<a name="E2nhl"></a></p> <h3 id="为什么要有微任务"><a href="#为什么要有微任务" class="header-anchor">#</a> 为什么要有微任务？</h3> <p><strong>为了在一个宏任务执行之后，浏览器渲染之前有执行任务的能力。减少渲染次数</strong><br><strong>宏任务遵循先进先出原则，微任务的出现就可以实现后到的任务优先执行</strong> <a name="Rk5ut"></a></p> <h2 id="_4、二者区别"><a href="#_4、二者区别" class="header-anchor">#</a> 4、二者区别</h2> <p>microtask queue：唯一，整个事件循环当中，仅存在一个；执行为同步，同一个事件循环中的microtask会按队列顺序，串行执行完毕；<br>macrotask queue：不唯一，存在一定的优先级（用户I/O部分优先级更高）；异步执行，同一事件循环中，只执行一个。
<a name="dElVk"></a></p> <h1 id="三、从线程的角度理解事件循环"><a href="#三、从线程的角度理解事件循环" class="header-anchor">#</a> 三、从线程的角度理解事件循环</h1> <ol><li><strong>GUI渲染线程</strong>对html进行解析</li> <li>当解析到script标签时，JS引擎读取JS代码，此时为同步环境，形成相应的堆和执行栈；</li> <li>主线程遇到异步任务，指给对应的异步线程进行处理（WEB API），但是事件队列就被区分为宏任务事件队列task queue，微任务事件队列microtask queue</li> <li>异步线程处理完毕（Ajax返回、DOM事件处罚、Timer到等），将相应的异步任务推入任务队列；
<ol><li>为dom元素，添加事件 =&gt; 通过<strong>事件触发线程</strong>，生成事件监听器（待确认）=&gt; 监听器监听到了用户触发事件的行为之后，将回调函数，推入task queue中</li> <li>解析到setTimeout或者setInterval定时器代码时 =&gt; 通过<strong>定时器线程</strong>，开启定时任务 =&gt; 定时器时间到达之后，会将回调函数推入task queue中</li> <li>遇到ajax请求 =&gt; 通过<strong>异步http请求线程</strong>，发送http请求 =&gt; 服务端返回响应后，会将成功或者失败的回调函数推入task queue中</li> <li>代码中使用了Promise或者async/await来处理异步 =&gt; 处理完成后 =&gt; 推入microtask queue中</li></ol></li> <li>当js执行线程中的代码执行完成之后，<strong>首先检查微任务队列头部是否有值</strong>，如果存在则将其推入到JS执行栈中执行，直到微任务队列头部为空。（执行微任务过程中产生新的微任务同样会在这个阶段执行完，直到微任务队列为空，再执行下一个宏任务）</li> <li><strong>如果宿主是浏览器，GUI渲染线程可能会重新渲染页面</strong></li> <li>然后检查宏任务队列头部是否有值，如果存在则将其推入到JS执行栈中执行，循环3456四个步骤，直到宏任务队列头部为空。</li> <li>当JS执行线程中的执行栈为空时，事件轮询机制会一直重复4-6这个循环
<a name="xIN3j"></a></li></ol> <h1 id="这里看一道案例"><a href="#这里看一道案例" class="header-anchor">#</a> 这里看一道案例</h1> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//（1）</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//（2）</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在清空微任务队列过程中如果有新的微任务加入，也要继续清空，再执行宏任务</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//（3）</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
  <span class="token comment">// return Promise.resolve('success')</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'then3'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这一段就会输出Promise1，Promise2，error，then3</span>
</code></pre></div><p>（1）这里调用async2 函数没有返回值，相当于返回 一个resolve undefined的 Promise，所以最后会输出下面的async1 start<br>（2）这里的 then1 会同步执行，then因为参数不是函数，就会用 value =&gt; value reason =&gt; { throw reason }替换 成功回调 和 失败回调，上面Promise是fulfilled状态，且没有resolve东西，value 就是 undefined，第一个then执行完就是返回一个fulfilled状态的Promise{undefined}<br>（3） then执行后返回的 Promise 的状态，会取决于回调函数的返回值，俗话说没有消息就是好消息，只要返回的不是抛出错误或者rejected状态的Promise，那就都是fulfilled状态，假如回调中抛出的是Promise，那么本次的then执行后返回的 Promise 的状态，就会取决于回调中返回的Promsie的状态举个例子：</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.47b00d9e.js" defer></script><script src="/assets/js/2.63c13255.js" defer></script><script src="/assets/js/14.9ccbfb79.js" defer></script>
  </body>
</html>
